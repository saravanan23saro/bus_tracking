<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Driver — Bus Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="styles.css" />
</head>
  <header class="app-header">
    <div class="title">Driver Dashboard</div>
    <div class="hdr-controls">
      <input id="busInput" placeholder="Bus ID (e.g. bus1)" />
      <button id="saveBusBtn" class="btn">Save</button>
      <button id="logoutBtn" class="btn ghost" style="margin-left:8px">Logout</button>
    </div>
  </header>
  <main class="app-main">
    <div id="map">Map loading...</div>
    <div class="bottom-bar">
      <div class="controls">
        <button id="startBtn" class="btn">Start Sharing</button>
        <button id="stopBtn" class="btn ghost" disabled>Stop</button>
      </div>
      <div class="status" id="status">Not sharing</div>
    </div>
  </main>
  

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    // minimal driver: save bus id and share location
    const savedBus = localStorage.getItem('busTracker.busId') || '';
    const name = localStorage.getItem('busTracker.name') || 'driver';
    const busInput = document.getElementById('busInput');
    const saveBusBtn = document.getElementById('saveBusBtn');
    const statusEl = document.getElementById('status');
    if (savedBus) busInput.value = savedBus;
    saveBusBtn.addEventListener('click', () => {
      const v = busInput.value.trim();
      if (!v) { alert('Enter a bus id'); return; }
      localStorage.setItem('busTracker.busId', v);
      statusEl.textContent = 'Saved: ' + v;
    });

    // Leaflet map (no Mapbox/WebGL)
    let map = null;
    try {
      const defaultCenter = [10.9974, 76.9589]; // [lat, lng]
      map = L.map('map').setView(defaultCenter, 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
    } catch (err) {
      console.error('Leaflet init failed', err);
      document.getElementById('map').textContent = 'Map init error: ' + (err && err.message || err);
    }
    let marker = null;

    // Initialize Firebase using shared config (or warn if not set)
    if (!window.FIREBASE_CONFIG || window.FIREBASE_CONFIG.apiKey.startsWith('REPLACE')) {
      console.warn('firebase-config.js not configured. Please set real Firebase config in firebase-config.js');
    }
    if (!firebase.apps || !firebase.apps.length) {
      firebase.initializeApp(window.FIREBASE_CONFIG);
    }
    const database = firebase.database();

    // check secure origin: geolocation requires https or localhost
    const isSecureOrigin = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    if (!isSecureOrigin) {
      const notice = document.getElementById('insecureNotice');
      if (notice) notice.style.display = 'block';
      document.getElementById('startBtn').disabled = true;
    }

    let watchId = null;
    function setStatus(text) { statusEl.textContent = text; }

    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('busTracker.role');
      localStorage.removeItem('busTracker.busId');
      localStorage.removeItem('busTracker.name');
      location.href = 'login.html';
    });

    document.getElementById('startBtn').addEventListener('click', () => {
      if (!navigator.geolocation) { alert('Geolocation not supported'); return; }
      if (!isSecureOrigin) { alert('Geolocation requires a secure origin (HTTPS or localhost). See the banner for options.'); return; }
      if (watchId !== null) return;

      watchId = navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const payload = { lat, lng, timestamp: Date.now(), driver: name };

        const busId = localStorage.getItem('busTracker.busId');
        if (!busId) { setStatus('No bus id saved — save before starting'); return; }

        database.ref(`buses/${busId}/location`).set(payload)
          .then(() => {
            // update map marker
            if (map) {
              if (!marker) marker = L.marker([lat, lng]).addTo(map);
              else marker.setLatLng([lat, lng]);
              map.setView([lat, lng], 15);
            }
            setStatus('Sharing — ' + new Date(payload.timestamp).toLocaleTimeString());
            document.getElementById('stopBtn').disabled = false;
          })
          .catch(err => { console.error('Write failed', err); setStatus('Write error'); });

      }, err => { console.error(err); setStatus('Location error'); }, { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 });
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
      if (watchId !== null) { navigator.geolocation.clearWatch(watchId); watchId = null; setStatus('Stopped'); document.getElementById('stopBtn').disabled = true; }
    });

    // no debug UI in minimal mode
  </script>
</body>
</html>
