<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Student â€” Bus Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f4f7fb}
    header{padding:12px 18px;background:#fff;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #e6ebf0}
    main{padding:18px}
    #map{width:100%;height:70vh;border-radius:8px;border:1px solid #ddd}
    .info{margin-top:12px}
  </style>
</head>
<body>
  <header>
    <div>Student View</div>
  </header>
  <main>
    <div style="margin-bottom:8px">
      <input id="busSelect" placeholder="Enter Bus ID (e.g. bus1)" style="padding:6px;border:1px solid #ccc;border-radius:4px;width:220px" />
      <button id="watchBtn" style="margin-left:8px;padding:6px 10px">Watch</button>
      <button id="stopBtn" disabled style="margin-left:6px;padding:6px 10px">Stop</button>
      <span id="lastUpdate" style="margin-left:12px;color:#333">&nbsp;</span>
    </div>

    <div id="map">Loading map...</div>
  </main>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    // Minimal student view: enter a bus id and watch live location
    let map = null;
    try {
      const defaultCenter = [17.3850, 78.4867];
      map = L.map('map').setView(defaultCenter, 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
    } catch (err) {
      document.getElementById('map').textContent = 'Map init error: ' + (err && err.message || err);
    }

    if (!firebase.apps || !firebase.apps.length) {
      if (!window.FIREBASE_CONFIG) throw new Error('Missing firebase-config.js');
      firebase.initializeApp(window.FIREBASE_CONFIG);
    }
    const database = firebase.database();

    const busInput = document.getElementById('busSelect');
    const watchBtn = document.getElementById('watchBtn');
    const stopBtn = document.getElementById('stopBtn');
    const lastUpdate = document.getElementById('lastUpdate');

    let currentRef = null;
    let marker = null;

    // auto-start if saved
    const saved = localStorage.getItem('busTracker.busId');
    if (saved) { busInput.value = saved; startWatching(); }

    function startWatching() {
      const busId = busInput.value.trim();
      if (!busId) { alert('Enter bus id to watch'); return; }
      localStorage.setItem('busTracker.busId', busId);
      if (currentRef) currentRef.off();
      currentRef = database.ref(`buses/${busId}/location`);
      currentRef.on('value', snap => {
        const d = snap.val();
        if (d && typeof d.lat === 'number' && typeof d.lng === 'number') {
          if (!marker) marker = L.marker([d.lat, d.lng]).addTo(map);
          else marker.setLatLng([d.lat, d.lng]);
          map.setView([d.lat, d.lng], 15);
          lastUpdate.textContent = 'Last: ' + new Date(d.timestamp || Date.now()).toLocaleTimeString();
          stopBtn.disabled = false;
        } else {
          lastUpdate.textContent = 'No location yet';
        }
      });
    }

    function stopWatching() {
      if (currentRef) { currentRef.off(); currentRef = null; stopBtn.disabled = true; lastUpdate.textContent = 'Stopped'; }
    }

    watchBtn.addEventListener('click', startWatching);
    stopBtn.addEventListener('click', stopWatching);
  </script>
</body>
</html>
