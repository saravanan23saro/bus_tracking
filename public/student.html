<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Student — Bus Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="app-header">
    <div class="title">Student View</div>
    <div id="busLabel" class="muted small" style="margin-left:8px"></div>
    <div class="hdr-controls">
      <input id="busSelect" placeholder="Bus ID (e.g. bus1)" />
      <button id="watchBtn" class="btn">Watch</button>
      <button id="stopBtn" class="btn ghost" disabled>Stop</button>
      <button id="logoutBtn" class="btn ghost" style="margin-left:8px">Logout</button>
    </div>
  </header>
  
  <div id="debug" style="display:none">Debug</div>
  <div id="insecureNotice" style="display:none">This page is not secure (not HTTPS). For live geolocation use, open via <code>localhost</code>, deploy to HTTPS, or use a secure tunnel like <code>ngrok</code>.</div>
  <main class="app-main">
    <div id="map">Loading map...</div>
    <div class="info-row">
      <div class="info" id="info">No data yet</div>
      <div class="small">Remaining: <span id="remaining">n/a</span></div>
      <div class="small">ETA: <span id="eta">n/a</span></div>
    </div>
  </main>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    let map = null;
    try {
      const defaultCenter = [10.9974, 76.9589]; // [lat, lng]
      map = L.map('map').setView(defaultCenter, 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
    } catch (err) {
      console.error('Leaflet init failed', err);
      document.getElementById('map').textContent = 'Map init error: ' + (err && err.message || err);
    }
    let marker = null;
    let currentRef = null;
    let routeLine = null;
    let studentLocation = null;

    if (!window.FIREBASE_CONFIG || window.FIREBASE_CONFIG.apiKey.startsWith('REPLACE')) {
      console.warn('firebase-config.js not configured. Please set real Firebase config in firebase-config.js');
    }

    // secure origin check
    const isSecureOrigin = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    if (!isSecureOrigin) {
      const n = document.getElementById('insecureNotice');
      if (n) n.style.display = 'block';
      document.getElementById('watchBtn').disabled = true;
    }

    if (!firebase.apps || !firebase.apps.length) {
      firebase.initializeApp(window.FIREBASE_CONFIG);
    }
    const database = firebase.database();

    const busInput = document.getElementById('busSelect');
    const watchBtn = document.getElementById('watchBtn');
    const stopBtn = document.getElementById('stopBtn');
    const info = document.getElementById('info');

    // prefill from login session if exists
    const savedBus = localStorage.getItem('busTracker.busId');
    if (savedBus) { busInput.value = savedBus; document.getElementById('busLabel').textContent = savedBus; }

    function startWatching() {
      const busId = busInput.value.trim();
      if (!busId) { alert('Enter bus id'); return; }

      // Prompt for student location if not set
      if (!studentLocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          studentLocation = [pos.coords.lat, pos.coords.lng];
        }, function() {
          // fallback: use default center
          studentLocation = [10.9974, 76.9589];
        });
      }

      if (currentRef) currentRef.off();
      currentRef = database.ref(`buses/${busId}/location`);

      currentRef.on('value', snap => {
        const d = snap.val();
        if (d && d.lat && d.lng) {
          const driverLatLng = [d.lat, d.lng];
          if (map) {
            if (!marker) { marker = L.marker(driverLatLng).addTo(map); }
            else { marker.setLatLng(driverLatLng); }
            map.setView(driverLatLng, 15);
          }
          info.textContent = `Last update: ${new Date(d.timestamp || Date.now()).toLocaleTimeString()} — driver: ${d.driver || 'unknown'}`;
          stopBtn.disabled = false;

          // Draw route from driver to student
          if (studentLocation) {
            fetchRoute(driverLatLng, studentLocation);
          }
        } else {
          info.textContent = 'No valid location found for ' + busId;
        }
      });
    }

    function fetchRoute(driverLatLng, studentLatLng) {
      // OSRM API expects [lng,lat]
      const url = `https://router.project-osrm.org/route/v1/driving/${driverLatLng[1]},${driverLatLng[0]};${studentLatLng[1]},${studentLatLng[0]}?overview=full&geometries=geojson`;
      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (data.routes && data.routes.length) {
            const route = data.routes[0];
            const coords = route.geometry.coordinates.map(c => [c[1], c[0]]); // [lat,lng]
            if (routeLine) { map.removeLayer(routeLine); }
            routeLine = L.polyline(coords, { color: '#2b6cdf', weight: 5, opacity: 0.8 }).addTo(map);
            document.getElementById('remaining').textContent = (route.distance/1000).toFixed(2) + ' km';
            document.getElementById('eta').textContent = Math.ceil(route.duration/60) + ' min';
          }
        })
        .catch(() => {
          document.getElementById('remaining').textContent = 'n/a';
          document.getElementById('eta').textContent = 'n/a';
        });
    }

    function stopWatching() {
      if (currentRef) { currentRef.off(); currentRef = null; info.textContent = 'Stopped'; stopBtn.disabled = true; }
    }

    watchBtn.addEventListener('click', startWatching);
    stopBtn.addEventListener('click', stopWatching);
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('busTracker.role');
      localStorage.removeItem('busTracker.busId');
      localStorage.removeItem('busTracker.name');
      location.href = 'login.html';
    });

    // Debug panel updates
    function updateDebug() {
      try {
        const dbg = document.getElementById('debug');
        if (!dbg) return;
        const rows = [];
        rows.push('L defined: ' + (typeof L !== 'undefined'));
        rows.push('map object: ' + (!!map));
        rows.push('marker present: ' + (!!marker));
        rows.push('FIREBASE_CONFIG: ' + (window.FIREBASE_CONFIG ? 'loaded' : 'missing'));
        rows.push('databaseURL: ' + (window.FIREBASE_CONFIG && window.FIREBASE_CONFIG.databaseURL ? window.FIREBASE_CONFIG.databaseURL : 'n/a'));
        rows.push('protocol: ' + location.protocol + ' (needs https for geolocation on some browsers)');
        dbg.innerText = rows.join('\n');
        console.log('DEBUG:', rows.join(' | '));
      } catch (e) { console.error(e); }
    }
    updateDebug();
    setInterval(updateDebug, 3000);
    window.addEventListener('error', (ev) => {
      const dbg = document.getElementById('debug');
      if (dbg) dbg.innerText += '\nERROR: ' + (ev && ev.message || ev);
      console.error('Window error', ev);
    });
  </script>
</body>
</html>
